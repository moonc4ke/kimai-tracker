name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: vps-deploy
      cancel-in-progress: false

    steps:
      - name: Check and Add GitHub to known hosts if not present
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.UBUNTU_SERVER_IP }}
          username: dondoncece
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            [ -d ~/.ssh ] || mkdir -p ~/.ssh
            [ -f ~/.ssh/known_hosts ] || touch ~/.ssh/known_hosts
            if ! ssh-keygen -F github.com > /dev/null; then
              ssh-keyscan github.com >> ~/.ssh/known_hosts
            fi

      - name: SSH and update code
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.UBUNTU_SERVER_IP }}
          username: dondoncece
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~
            if [ -d "kimai-tracker" ]; then
              cd kimai-tracker
              git pull origin main
            else
              git clone git@github.com:moonc4ke/kimai-tracker.git kimai-tracker
              cd kimai-tracker
            fi

      - name: Add Environment Variables to .env
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.UBUNTU_SERVER_IP }}
          username: dondoncece
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/kimai-tracker
            echo "DATABASE_NAME=${{ secrets.DATABASE_NAME }}" > .env
            echo "DATABASE_USER=${{ secrets.DATABASE_USER }}" >> .env
            echo "DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}" >> .env
            echo "DATABASE_ROOT_PASSWORD=${{ secrets.DATABASE_ROOT_PASSWORD }}" >> .env
            echo "ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}" >> .env
            echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" >> .env

      - name: Stop and Run Docker Compose
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.UBUNTU_SERVER_IP }}
          username: dondoncece
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/kimai-tracker
            docker-compose down
            docker-compose up -d

      - name: Prune Unused Docker Objects
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.UBUNTU_SERVER_IP }}
          username: dondoncece
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            docker container prune -f
            docker image prune -a -f
            docker volume prune -f